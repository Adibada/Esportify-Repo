applications:
  app:
    type: php:8.3

    runtime:
        extensions:
            - apcu
            - mbstring
            - sodium
            - ctype
            - iconv

    build:
        flavor: none

    web:
        locations:
            "/":
                root: "public"
                expires: 1h
                passthru: "/index.php"

    mounts:
        "/var/cache": { source: tmp, source_path: var/cache }

    relationships:
      database: "db:mysql"
        
    hooks:
        build: |
            set -x -e

            curl -fs https://get.symfony.com/cloud/configurator | bash
            
            NODE_VERSION=22 symfony-build

        deploy: |
            set -x -e

            symfony-deploy

    crons:
        security-check:
            spec: '50 23 * * *'
            commands:
                start: if [ "$PLATFORM_ENVIRONMENT_TYPE" = "production" ]; then croncape COMPOSER_ROOT_VERSION=1.0.0 COMPOSER_AUDIT_ABANDONED=ignore composer audit --no-cache; fi
        clean-expired-sessions:
            spec: '17,47 * * * *'
            commands:
                start: croncape php-session-clean

services:
  db:
    type: oracle-mysql:8.0

routes:
  "https://{all}/":
    type: upstream
    upstream: "app:http"
  "http://{all}/":
    type: redirect
    to: "https://{all}/"
